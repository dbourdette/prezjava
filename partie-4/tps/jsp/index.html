<!DOCTYPE HTML>
<html>
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1">
    <title>Java Server Pages</title>

    <link href="../../../common/css/css.css" rel="stylesheet" type="text/css">
    <link href="../../../common/css/prettify.css" rel="stylesheet" id="prettify-link">
    <link href="../../../common/css/default.css" class="theme" rel="stylesheet">
    <link href="../../../common/css/dev.css" class="theme" rel="stylesheet">
    <link href="../../../common/css/project.css" class="theme" rel="stylesheet">

    <script src="../../../common/js/prettify.js"></script>

</head>
<body onload="prettyPrint();">
<div class="presentation">
    <div id="project">
        <h1>Java Server Pages</h1>

        <p>Les fichiers jsp sont les composants spécialisés dans la génération de html.</p>

        <p>Au moment de générer le rendu, la servlet passe donc la main à une jsp.</p>

	          <pre  class="prettyprint">
public class HelloWorldSerlvet extends HttpServlet {
    @Override
    protected void doGet(...) ... {
        ...

    	<b>request.setAttribute("name", request.getParameter("name"));</b>

        <b>request.getRequestDispatcher("/WEB-INF/jsp/hello.jsp").forward(request, response);</b>
    }
}</pre>

        <p>Et le fichier hello.jsp dans le répertoire WEB-INF :</p>

        <pre class="prettyprint">
&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;
&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"&gt;
&lt;html&gt;
   &lt;head&gt;&lt;/head&gt;
   &lt;body&gt;Hello ${name} ! (from jsp file)&lt;/body&gt;
&lt;/html&gt;</pre>

        <p>Le résultat sur <a href="http://localhost:8080/HelloWorldServlet?name=Steven" target="_blank">http://localhost:8080/HelloWorldServlet?name=Steven</a>.</p>

        <div class="note">Afin d'être sûr d'avoir la complétion dans les fichiers jsp, il faut utiliser la perspective Java EE</div>

        <h2>Techniquement</h2>

        <p>Par convention, les fichiers jsp sont dans le répertoire WEB-INF/jsp du war.</p>

        <p>Sous maven, ils sont donc dans src/main/webapp/WEB-INF/jsp.</p>

        <p>Les fichiers jsp sont compilés à la volée en fichiers servlets puis en bytecode (.class).</p>

        <p>Un peu à l'image d'un fichier php, les fichiers jsp sont donc interprétés par le conteneur.</p>

        <p>Avec la commande mvn tomcat:run, les modifications sont prises en compte à la volée.</p>

        <h2>Notre template</h2>

        <p>Pour commencer, on déplace notre index.html vers WEB-INF/jsp/index.jsp.</p>

        <p>Avant la déclaration du DOCTYPE, on ajoute :</p>

        <pre  class="prettyprint">&lt;%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%&gt;</pre>

        <p>Cela indique au container que le code source est en utf-8 ainsi que le charset au runtime.</p>

        <p>On rajoute la servlet IndexServlet</p>

        <pre  class="prettyprint">public class IndexServlet extends HttpServlet {
  private static final long serialVersionUID = 1L;

  @Override
  protected void doGet(HttpServletRequest request,
      HttpServletResponse response) throws ServletException, IOException {
    request.getRequestDispatcher("WEB-INF/jsp/index.jsp").forward(request, response);
  }
}</pre>

        <p>Que l'on déclare dans le web.xml</p>

        <pre  class="prettyprint">&lt;servlet&gt;
    &lt;servlet-name&gt;index&lt;/servlet-name&gt;
    &lt;servlet-class&gt;fr.todooz.web.servlet.IndexServlet&lt;/servlet-class&gt;
&lt;/servlet&gt;
&lt;servlet-mapping&gt;
    &lt;servlet-name&gt;index&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/index.html&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;</pre>

        <p>Notre page est donc accessible sur <a href="http://localhost:8080/">http://localhost:8080/</a> en étant passé au travers de la servlet.</p>

        <h2>Un peu de données</h2>

        <p>Afin de jouer un peu avec les capacités des jsp, nous allons injecter quelques données depuis la servlet.</p>

        <pre class="prettyprint">@Override
protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
    request.setAttribute("tasks", DummyData.tasks());

    request.getRequestDispatcher("WEB-INF/jsp/index.jsp").forward(request, response);
}</pre>

        <p>Et la classe DummyData</p>

        <pre class="prettyprint">public class DummyData {
  public static List&lt;Task&gt; tasks() {
    private static final int TASK_COUNT = 10;

    List&lt;Task&gt; tasks = new ArrayList&lt;Task&gt;();

    for (int i = 0; i &lt; TASK_COUNT; i++) {
        tasks.add(task());
    }

    return tasks;
  }

  private static Task task() {
    Task task = new Task();

    task.setDate(new Date());
    task.setTitle("Read Effective Java");
    task.setText("Read Effective Java before it's too late");
    task.setTags("java,java");

    return task;
  }
}</pre>

        <p>Les attributs de la requête sont conservé tout au long du traitement de la requête.</p>

        <p>Ils sont donc accessibles dans la jsp.</p>

        <h2>Expression Language</h2>

        <p>L'EL (Expression Language) est une notation permettant d'exploiter facilement les données.</p>

        <pre class="prettyprint">${expression}</pre>

        <p>Les capacités sont limités mais généralement suffisantes pour afficher des données.</p>

        <p>Par exemple, on peut simplement afficher l'attribut tasks.</p>

        <pre class="prettyprint">${tasks}</pre>

        <p>Ce qui donne</p>

        <pre class="prettyprint">[fr.todooz.domain.Task@16ff6348, fr.todooz.domain.Task@58cf17c3, fr.todooz.domain.Task@42130c2,
fr.todooz.domain.Task@1f0812ac, fr.todooz.domain.Task@4b01ea1e, fr.todooz.domain.Task@6ab17e0a,
fr.todooz.domain.Task@2ac9f93f, fr.todooz.domain.Task@320aad0b, fr.todooz.domain.Task@5ae6c6d7,
fr.todooz.domain.Task@65087be0]</pre>

        <p>Ce n'est pas très parlant (il faudrait implémenter la méthode toString() afin d'y voir plus en détails)</p>

        <p>Les expressions suivantes sont valides.</p>

        <pre class="prettyprint">${tasks[0].title}
${empty tasks}
${not empty task.date ? task.date : 'no date'}</pre>

        <p>L'EL est une notation simple et puissante par rapport a du code java.</p>

        <pre class="prettyprint">${cart.items[2].name}</pre>

        <p>Synthétise un appel qui pourrait être écrit comme suit</p>

	    <pre class="prettyprint">Cart cart = (Cart) request.getSession().getAttribute("cart");

String name = cart.getItems().get(2).getName();

response.getWriter().write(name);</pre>

        <h2>Les custom tags</h2>

        <p>Ce sont des morceaux de code en java que l'on peut appeler depuis les jsp.</p>

        <p>Ils permettent de faire du contrôle de flow (if, for each...) et de factoriser du code.</p>

        <p>La librairie la plus utilisées est la jstl (java standard tag library) et il est assez simple de faire ses propres custom tags.</p>

        <p>Afin de pouvoir l'utiliser, on ajoute les libs dans le pom (+ mvn eclipse:eclipse).</p>

        <pre class="prettyprint">&lt;dependency&gt;
    &lt;groupId&gt;javax.servlet&lt;/groupId&gt;
    &lt;artifactId&gt;jstl&lt;/artifactId&gt;
    &lt;version&gt;1.1.2&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
   &lt;groupId&gt;taglibs&lt;/groupId&gt;
   &lt;artifactId&gt;standard&lt;/artifactId&gt;
   &lt;version&gt;1.1.2&lt;/version&gt;
   &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency></pre>

        <p>Et on déclare les taglibs utilisées en haut du fichier jsp.</p>

        <pre class="prettyprint">&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %&gt;
&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %&gt;</pre>

        <p>Un <a href="http://adiguba.developpez.com/tutoriels/j2ee/jsp/jstl/" class="external" target="_blank">bon tutorial sur la jstl</a> est disponible sur le site de developpez.com</p>

        <h2>Notre liste de tâches</h2>

        <p>En utilisant les notations suivantes, mettre en forme la jsp afin qu'elle produise la liste des tâches.</p>

        <p>L'itération :</p>

        <pre class="prettyprint">&lt;c:forEach var="task" items="${tasks}"&gt;...&lt;/c:forEach&gt;</pre>

        <p>L'expression language :</p>

        <pre class="prettyprint">${task.title} ${task.text} ${task.tags}</pre>

        <p>Le formattage de date :</p>

        <pre class="prettyprint">&lt;fmt:formatDate value="${task.date}" pattern="dd MMM yyyy"/&gt;</pre>

        <p>Et en utilisant la lib commons lang</p>

        <pre class="prettyprint">&lt;dependency&gt;
    &lt;groupId&gt;commons-lang&lt;/groupId&gt;
    &lt;artifactId&gt;commons-lang&lt;/artifactId&gt;
    &lt;version&gt;2.6&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;</pre>

        <p>On peut ajouter la méthode suivante dans la classe Task.</p>

        <pre class="prettyprint">public String[] getTagArray() {
  return StringUtils.split(tags, ",");
}</pre>

        <p>Et l'utiliser dans notre jsp.</p>

        <p>La jsp itère donc dans notre modèle afin de construire le html.</p>

        <h2>Les tag files</h2>

        <p>Les tags files permettent de factoriser du code jsp.</p>

        <p>On ne peut pas les packager dans un jar mais elles sont plus simples a mettre en place que les customs tags.</p>

        <p>Par exemple, si on ajoute le fichier header.tag dans le répertoire WEB-INF/tags/widget.</p>
	    
        <pre  class="prettyprint">&lt;%@ tag language="java" pageEncoding="UTF-8"%&gt;

&lt;div class="navbar navbar-inverse"&gt;
    &lt;div class="navbar-inner"&gt;
        &lt;span class="brand"&gt;Todooz&lt;/span&gt;
        &lt;form class="navbar-search pull-left"&gt;
            &lt;input type="text" class="search-query" placeholder="Search"&gt;
        &lt;/form&gt;
        &lt;a href="/add" class="btn btn-inverse pull-right"&gt;&lt;i class="icon-plus icon-white"&gt;&lt;/i&gt;&lt;/a&gt;
    &lt;/div&gt;
&lt;/div&gt;</pre>

        <p>On peut ajouter la déclaration suivante dans notre jsp.</p>

        <pre class="prettyprint"><b>&lt;%@ taglib tagdir="/WEB-INF/tags/widget" prefix="widget" %&gt;</b></pre>

        <p>Et faire l'appel suivant à la place de la navbar.</p>

        <pre  class="prettyprint">&lt;widget:navbar /&gt;</pre>

        <p>Cela ressemble à un include mais la synthaxe est élégante.</p>

        <p>Sachant que la déclaration d'un attribut dans un tag file à la forme.</p>

        <pre class="prettyprint">&lt;%@ attribute name="task" required="true" type="fr.todooz.domain.Task" %&gt;</pre>

        <p>Faire un tag file task.tag qui affiche une tâche.</p>

        <h2>Les fonctions</h2>

        <p>Afin de tester les fonctions, nous allons régler un dernier petit problème</p>

        <p>Si le titre d'une tâche contient un &lt; alors l'insert</p>

        <pre class="prettyprint">${task.title}</pre>

        <p>Va générer un html mal formé.</p>

        <p>Afin de s'assurer que les chaînes de caractères sont bien escapées, on utilise la jstl functions.</p>

        <pre class="prettyprint">&lt;%@ taglib uri="http://java.sun.com/jsp/jstl/functions" prefix="fn" %&gt;</pre>

        <p>Et la méthode escapeXml</p>

        <pre class="prettyprint">${fn:escapeXml(task.title)}</pre>

        <p>Il faut faire de même avec les tags et le texte.</p>

        <p>On note que l'on aurait pu afficher les tags en utilisant la fonctions split de la jstl.</p>

        <h2>Une boite à outils</h2>

        <p>Les jsp sont un outils riche (trop ?) pour intégrer du html.</p>

        <p>On y retrouve :</p>

        <ul>
            <li>les directives jsp</li>
            <li>l'expression language</li>
            <li>les customs tags (tag et fonctions)</li>
            <li>les tags files</li>
        </ul>

        <p>Elles sont très rarement exposées directement et marchent en couple avec des controleurs.</p>
    </div>
</div>
</body>
</html>